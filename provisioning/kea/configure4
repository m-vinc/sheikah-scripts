#!/bin/bash

set -o pipefail

TMP=$(mktemp)
KEA_DHCP4_TARGET="/etc/kea/kea-dhcp4.conf"
KEA_CTRL_AGENT_TARGET="/etc/kea/kea-ctrl-agent.conf"
ENABLE_CTRL_AGENT="${ENABLE_CTRL_AGENT:=true}"
DHCP_MI=${DHCP_MI:-par3::dhcp::v4}

DATA=$(sheikahctl get "$DHCP_MI")
if [[ $? -ne 0 ]]; then
        echo "unable to fetch data from sheikah"
        rm -f $TMP
        exit 1
fi

echo "backuping existing configuration: $KEA_DHCP4_TARGET.bak"
cp "$KEA_DHCP4_TARGET" "$TARGET.bak"
chown kea: "$KEA_DHCP4_TARGET.bak"

RES=$(echo "$DATA" | gomplate -d dhcp=stdin://in.json?type=application/json -f /etc/sheikah/kea/kea-dhcp4.conf.tpl -o $TMP)
if [[ $? -ne 0 ]]; then
        echo "unable to generate dhcp config from sheikah data: $RES"
        rm -f "$TMP"
        exit 1
fi

RES=$(kea-dhcp4 -t $TMP)
if [[ $? -ne 0 ]]; then
        echo "unable to validate generated from kea: $RES"
        # rm -f "$TMP"
	echo "generated template is: $TMP, remove it after debugging"
        exit 1
fi

mv $TMP $KEA_DHCP4_TARGET
chown kea: $KEA_DHCP4_TARGET
restorecon -v $KEA_DHCP4_TARGET

if [[ "$ENABLE_CTRL_AGENT" = "true" ]]; then
        RES=$(echo "$DATA" | gomplate -d dhcp=stdin://in.json?type=application/json -f /etc/sheikah/kea/kea-ctrl-agent.conf.tpl -o $TMP)
        RC=$?
        if [[ $RC -ne 0 ]]; then
                echo "[$RC] unable to generate kea ctrl agent config from sheikah data: $RES"
                rm -f "$TMP"
                exit 1
        fi

        RES=$(kea-ctrl-agent -t $TMP)
        if [[ $? -ne 0 ]]; then
                echo "unable to validate generated from kea: $RES"
                rm -f "$TMP"
                exit 1
        fi

        mv $TMP $KEA_CTRL_AGENT_TARGET
        chown kea: $KEA_CTRL_AGENT_TARGET
        restorecon -v $KEA_CTRL_AGENT_TARGET
fi
